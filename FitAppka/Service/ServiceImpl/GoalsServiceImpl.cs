using FitAppka.Models;
using FitAppka.Repository;
namespace FitAppka.Service.ServiceImpl
{
    public class GoalsServiceImpl : IGoalsService
    {
        private readonly IClientRepository _clientRepository;
        private readonly IDietaryTargetsService _dietaryTargetsService;

        public GoalsServiceImpl(IClientRepository clientRepository, IDietaryTargetsService dietaryTargetsService)
        {
            _dietaryTargetsService = dietaryTargetsService;
            _clientRepository = clientRepository;
        }

        public void UpdateGoals(CreateGoalsModel m)
        {
            _dietaryTargetsService.SetTargetsInDaysFromToday(_clientRepository.Update(SetClientTargets(m, SetClientPreferences(m))));
        }

        private Client SetClientPreferences(CreateGoalsModel m){
            Client client = _clientRepository.GetLoggedInClient();
            client.AutoDietaryGoals = m.AutoGeneratedDietaryGoals;
            client.IncludeCaloriesBurned = m.IncludeCaloriesBurnedInBalance;
            client.TrainingTimeGoal = m.TrainingTimeGoal;
            client.KcalBurnedGoal = m.CaloriesBurnedGoal;
            return client;
        }

        private Client SetClientTargets(CreateGoalsModel m, Client client)
        {
            if (m.AutoGeneratedDietaryGoals) {
                return CountClientTargets(client);
            }
            else {
                return SetClientTargets(client, (int)m.CaloriesTarget, (int)m.CarbohydratesTarget, (int)m.ProteinsTarget, (int)m.FatsTarget);
            }
        }

        private Client CountClientTargets(Client c)
        {
            int calorieTarget = _dietaryTargetsService.CountCalorieTarget((int) c.CaloricDemand, c.WeightChangeGoal, (double) c.PaceOfChanges);
            int proteinsTarget = _dietaryTargetsService.CountProteinTarget(_dietaryTargetsService.GetLastWeightMeasurement(), calorieTarget, c.ActivityLevel);
            int fatsTarget = _dietaryTargetsService.CountFatTarget(calorieTarget);
            int carbsTarget = _dietaryTargetsService.CountCarbsTarget(calorieTarget, proteinsTarget, fatsTarget);
            return SetClientTargets(c, calorieTarget, carbsTarget, proteinsTarget, fatsTarget);
        }

        private Client SetClientTargets(Client c, int kcalTarget, int carbsTarget, int proteinsTarget, int fatsTarget)
        {
            c.CalorieGoal = kcalTarget;
            c.CarbsTarget = carbsTarget;
            c.ProteinTarget = proteinsTarget;
            c.FatTarget = fatsTarget;
            return c;
        }

       
    }
}
